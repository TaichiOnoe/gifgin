<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.1/cropper.js"></script>
<script type="text/javascript" src="gif.js"></script>
<script type="text/javascript" src="gif.worker.js"></script>
<script src="https://unpkg.com/@webcomponents/webcomponentsjs@latest/webcomponents-loader.js"></script>
<script
    async
    src="https://unpkg.com/wired-elements@latest/dist/wired-elements.bundled.js"
    >
</script>

<html>
    <title>gifgin</title>
    <div>
    <span><font size="7">gifgin</font></span>
    <wired-spinner id="sp" style="top:20px;"></wired-spinner>
    <div>
    <div style="position: relative;">
        <canvas id="layer1" width="960" height="540" style="position:absolute; z-index: 0;"></canvas>
        <canvas id="layer2" width="960" height="540" style="position: absolute; z-index: 1;"></canvas>
    </div>
    <div style="position: relative; top: 560px;">
        <wired-progress id="progress" value="0" min="0" max="100"></wired-progress><br><br>
        <wired-button 
            id = "start"
            type="button"
            value="start"
            onclick="starCap()"
            elevation="3">
            Start
        </wired-button>
        <wired-button  
            id = "end" 
            type="button" 
            value="end" 
            onclick="endCap()" 
            elevation="3" 
            style="left:10px;">
            End
        </wired-button>
    </div>
</html>

<script>
    var is_down = false;

    var sx = 0
    var sy = 0
    var sdw = 960
    var sdh = 540

    var layer1 = document.getElementById("layer1")
    var layer2 = document.getElementById("layer2")
    var progress = document.getElementById("progress")
    var sp = document.getElementById("sp")   
    var display = document.createElement("video")
    var source = document.createElement("canvas");
    var cap = false
    navigator.mediaDevices.getDisplayMedia({ 
        video: {
            width: 960,
            height: 540,
            frameRate: 15
        }
    })
        .then(stream => {
            display.srcObject = stream
            display.play()
            render = setInterval(snapshot, 50); // Just so you don't need to click the button every time to see if the video actually lines up
            // we have a stream, attach it to a feedback video element
            //videoElement.srcObject = stream;
        }, error => {
            console.log("Unable to acquire screen capture", error);
        });
    function snapshot() {
        source.width = sdw
        source.height = sdh
        layer1.getContext("2d").drawImage(display, 0, 0, 960, 540);
        source.getContext("2d").drawImage(display, sx, sy, sdw, sdh, 0, 0, sdw, sdh);
        if(cap) {
            gif.addFrame(source.getContext("2d"), {delay: 50, copy: true})
        }
    }

    function starCap() {
        cap = true
        sp.style.color = "red"
        sp.spinning = true
        gif = new GIF({
            width: sdw,
            height: sdh,
            workers: 2,
            quality: 10
        });
        gif.on('progress', function(ptx){
           progress.value = ptx*100 
        })
        gif.on('finished', function(blob) {
            window.open(URL.createObjectURL(blob));
        });
    }
    function endCap() {
        cap = false
        sp.style.color = "black"
        sp.spinning = false
        gif.render()
        clearInterval(render)
    }

    layer2.addEventListener("click", onClick, false);

    function onClick(e) {
        var rect = e.target.getBoundingClientRect();
        if (!is_down) {
            begin = {x: e.clientX - rect.left, y: e.clientY - rect.top};
            is_down = true
        } else {
            is_down = false
            end = {x: e.clientX - rect.left, y: e.clientY - rect.top};
            setXYWH(begin, end)
            var fill = "rgba(0, 0, 0, 0.5)";
            fillRect(layer2, 0, 0, layer2.width, begin.y, fill); // top
            fillRect(layer2, 0, begin.y, begin.x, end.y - begin.y, fill); // left
            fillRect(layer2, end.x, begin.y, layer2.width - begin.x, end.y - begin.y, fill); // right
            fillRect(layer2, 0, end.y, layer2.width, layer2.height - end.y, fill); // bottom
        }
    }

    function setXYWH(begin, end) {
        sdw = Math.abs(begin.x - end.x)
        sdh = Math.abs(begin.y - end.y)
        if (begin.x < end.x && begin.y < end.y) {
            sx = begin.x
            sy = begin.y
        } else if (end.x < begin.x && end.y < begin.y) {
            sx = end.x
            sy = end.y
        }
    }
    function fillRect(canvas, x, y, width, height, style) {
        var ctx =  canvas.getContext("2d");
        ctx.beginPath();
        ctx.rect(x, y, width, height);
        ctx.fillStyle = style;
        ctx.fill();
    }
  function drawRect(canvas, x, y, width, height, line, style) {
    var ctx =  canvas.getContext("2d");
    ctx.beginPath();
    ctx.rect(x, y, width, height);
    ctx.lineWidth = line;
    ctx.strokeStyle = style;
    ctx.stroke();
  }
</script>
<style>
</style>
